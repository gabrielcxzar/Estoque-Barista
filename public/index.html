<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barista Pro | Gest√£o</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #F4F2EE; --bg-sidebar: #2C2624;
            --primary: #6F4E37; --primary-hover: #5D4037;
            --text-dark: #3E2723; --text-light: #F4F2EE;
            --accent: #D7CCC8; --danger: #C62828; --warning: #F57C00; --success: #388E3C;
            --radius: 8px; --shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-dark); display: flex; height: 100vh; overflow: hidden; }

        /* --- SIDEBAR --- */
        .sidebar { width: 250px; background: var(--bg-sidebar); color: var(--text-light); display: flex; flex-direction: column; padding: 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
        .logo { font-size: 1.5rem; font-weight: 700; margin-bottom: 40px; color: #D7CCC8; display: flex; align-items: center; gap: 10px; }
        
        .menu-btn { background: transparent; border: none; color: #aaa; padding: 15px; text-align: left; font-size: 1rem; cursor: pointer; border-radius: var(--radius); transition: 0.2s; display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        .menu-btn:hover { background: rgba(255,255,255,0.05); color: white; }
        .menu-btn.active { background: var(--primary); color: white; font-weight: 600; }

        /* --- CONTE√öDO PRINCIPAL --- */
        .main-content { flex: 1; overflow-y: auto; padding: 30px; position: relative; }
        .screen { display: none; animation: fadeIn 0.3s ease; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        h1 { font-size: 1.8rem; margin-bottom: 25px; color: var(--primary); border-bottom: 2px solid #E0E0E0; padding-bottom: 10px; }

        /* --- CARDS DASHBOARD --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); border-left: 5px solid var(--primary); }
        .stat-value { font-size: 2rem; font-weight: 700; color: var(--text-dark); margin: 10px 0; }
        .stat-label { font-size: 0.9rem; color: #777; font-weight: 500; }

        /* --- TABELAS --- */
        .table-card { background: white; border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; }
        .table-header-controls { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #FAFAFA; text-align: left; padding: 15px 20px; font-size: 0.85rem; color: #666; text-transform: uppercase; font-weight: 600; }
        td { padding: 15px 20px; border-bottom: 1px solid #eee; font-size: 0.95rem; }
        tr:hover { background: #f9f9f9; }

        /* --- BOT√ïES E INPUTS --- */
        .btn { padding: 10px 16px; border-radius: var(--radius); border: none; cursor: pointer; font-weight: 600; transition: 0.2s; font-size: 0.9rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-outline { background: white; border: 1px solid #ddd; color: #555; }
        .search-input { padding: 10px 15px; border: 1px solid #ddd; border-radius: 20px; width: 250px; background: #fafafa; }

        /* --- MODAIS E FORMUL√ÅRIOS --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 999; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; width: 500px; max-width: 90%; }
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; }
        
        /* Badges */
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 700; }
        .badge-in { background: #E8F5E9; color: var(--success); }
        .badge-out { background: #FFEBEE; color: var(--danger); }
        .badge-low { background: #FFF3E0; color: var(--warning); }
    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <nav class="sidebar">
        <div class="logo">‚òï Barista Pro</div>
        <button class="menu-btn active" onclick="showScreen('dashboard')">üìä Dashboard</button>
        <button class="menu-btn" onclick="showScreen('estoque')">üì¶ Estoque</button>
        <button class="menu-btn" onclick="showScreen('movimentacoes')">üìù Movimenta√ß√µes</button>
    </nav>

    <!-- CONTE√öDO -->
    <main class="main-content">
        
        <!-- TELA 1: DASHBOARD -->
        <section id="dashboard" class="screen active">
            <h1>Vis√£o Geral</h1>
            <div class="stats-grid">
                <div class="stat-card" style="border-color: var(--primary);">
                    <div class="stat-label">Valor Total em Estoque</div>
                    <div class="stat-value" id="dashValorTotal">R$ 0,00</div>
                </div>
                <div class="stat-card" style="border-color: var(--warning);">
                    <div class="stat-label">Itens Cr√≠ticos (Baixo Estoque)</div>
                    <div class="stat-value" id="dashItensCriticos">0</div>
                </div>
                <div class="stat-card" style="border-color: var(--danger);">
                    <div class="stat-label">Vencendo em 7 dias</div>
                    <div class="stat-value" id="dashVencendo">0</div>
                </div>
            </div>
            
            <div class="table-card">
                <div class="table-header-controls">
                    <h3>√öltimas Atividades</h3>
                </div>
                <table>
                    <thead><tr><th>Data</th><th>Produto</th><th>Tipo</th><th>Qtd</th></tr></thead>
                    <tbody id="dashUltimasAtividades"></tbody>
                </table>
            </div>
        </section>

        <!-- TELA 2: ESTOQUE (Funcionalidade Antiga) -->
        <section id="estoque" class="screen">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h1 style="margin:0; border:none;">Controle de Estoque</h1>
                <button class="btn btn-primary" onclick="abrirModalCadastro()">+ Novo Item</button>
            </div>

            <div class="table-card">
                <div class="table-header-controls">
                    <input type="text" id="buscaEstoque" class="search-input" placeholder="Buscar produto..." onkeyup="filtrarEstoque()">
                    <button class="btn btn-outline" onclick="gerarListaCompras()">üõí Lista de Compras</button>
                </div>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Produto</th>
                                <th>Qtd</th>
                                <th>Validade</th>
                                <th>Pre√ßo</th>
                                <th style="text-align: right;">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaEstoque"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- TELA 3: MOVIMENTA√á√ïES (NOVO) -->
        <section id="movimentacoes" class="screen">
            <h1>Hist√≥rico de Movimenta√ß√µes</h1>
            <div class="table-card">
                <table>
                    <thead>
                        <tr>
                            <th>Data / Hora</th>
                            <th>Produto</th>
                            <th>Tipo</th>
                            <th>Quantidade</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaHistorico"></tbody>
                </table>
            </div>
        </section>

    </main>

    <!-- MODAL DE CADASTRO/EDI√á√ÉO (Reaproveitado) -->
    <div id="modalForm" class="modal-overlay">
        <div class="modal-content">
            <h2 id="modalTitle" style="margin-bottom: 20px;">Novo Item</h2>
            <form id="formProduto">
                <input type="hidden" id="id_produto">
                <div class="form-row">
                    <input id="nome" placeholder="Nome" required>
                    <input id="categoria" placeholder="Categoria">
                </div>
                <div class="form-row">
                    <input type="number" id="quantidade" placeholder="Qtd" step="0.01" required>
                    <select id="unidade">
                        <option value="un">un</option>
                        <option value="kg">kg</option>
                        <option value="L">L</option>
                        <option value="g">g</option>
                        <option value="ml">ml</option>
                    </select>
                </div>
                <div class="form-row">
                    <input type="number" id="estoque_minimo" placeholder="M√≠nimo (Alerta)" step="0.01" required>
                    <input type="number" id="preco" placeholder="Custo (R$)" step="0.01">
                </div>
                <div class="form-row">
                    <div style="width: 100%;">
                        <label style="font-size: 0.8rem;">Validade</label>
                        <input type="date" id="data_validade">
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Salvar</button>
                    <button type="button" class="btn btn-outline" onclick="fecharModais()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- MODAL LISTA DE COMPRAS (Simplificado para o exemplo) -->
    <div id="modalLista" class="modal-overlay">
        <div class="modal-content">
            <h2>üõí Lista de Compras</h2>
            <textarea id="textoLista" style="width: 100%; height: 200px; margin: 15px 0; border: 1px solid #ddd; border-radius: 6px; padding: 10px;"></textarea>
            <button class="btn btn-primary" onclick="copiarLista()">Copiar</button>
            <button class="btn btn-outline" onclick="fecharModais()">Fechar</button>
        </div>
    </div>

<script>
    const API_URL = '/api/produtos';
    let produtosCache = [];
    let editando = false;

    // --- NAVEGA√á√ÉO ENTRE TELAS ---
    function showScreen(screenId) {
        // Esconde todas
        document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.menu-btn').forEach(el => el.classList.remove('active'));
        
        // Mostra a escolhida
        document.getElementById(screenId).classList.add('active');
        
        // Ativa bot√£o do menu
        // (L√≥gica simples baseada na ordem, ideal seria por ID do bot√£o)
        const btnIndex = screenId === 'dashboard' ? 0 : screenId === 'estoque' ? 1 : 2;
        document.querySelectorAll('.menu-btn')[btnIndex].classList.add('active');

        // Recarrega dados espec√≠ficos
        if(screenId === 'movimentacoes') carregarHistorico();
        if(screenId === 'dashboard') atualizarDashboard();
    }

    // --- INICIALIZA√á√ÉO ---
    document.addEventListener('DOMContentLoaded', () => {
        carregarEstoque();
        atualizarDashboard(); // J√° carrega o dash de cara
    });

    // --- L√ìGICA DO DASHBOARD ---
    async function atualizarDashboard() {
        if(produtosCache.length === 0) await carregarEstoque(); // Garante que tem dados
        
        // 1. Calcular Totais
        let valorTotal = 0;
        let criticos = 0;
        let vencendo = 0;
        const hoje = new Date();

        produtosCache.forEach(p => {
            valorTotal += (parseFloat(p.preco || 0) * parseFloat(p.quantidade));
            
            if(parseFloat(p.quantidade) <= parseFloat(p.estoque_minimo)) criticos++;

            if(p.data_validade) {
                const val = new Date(p.data_validade);
                const diff = (val - hoje) / (1000 * 60 * 60 * 24);
                if(diff <= 7 && diff >= -1) vencendo++;
            }
        });

        // 2. Atualizar Cards
        document.getElementById('dashValorTotal').innerText = `R$ ${valorTotal.toFixed(2)}`;
        document.getElementById('dashItensCriticos').innerText = criticos;
        document.getElementById('dashVencendo').innerText = vencendo;

        // 3. Mini Tabela de Hist√≥rico (Pega os 5 √∫ltimos)
        const res = await fetch('/api/movimentacoes');
        const movs = await res.json();
        const tbody = document.getElementById('dashUltimasAtividades');
        tbody.innerHTML = movs.slice(0, 5).map(m => `
            <tr>
                <td style="color: #777;">${new Date(m.data_movimentacao).toLocaleDateString()}</td>
                <td><strong>${m.produto_nome}</strong></td>
                <td>${formatarTipo(m.tipo)}</td>
                <td>${m.quantidade} ${m.unidade || ''}</td>
            </tr>
        `).join('');
    }

    // --- L√ìGICA DO ESTOQUE (CRUD) ---
    async function carregarEstoque() {
        const res = await fetch(API_URL);
        produtosCache = await res.json();
        renderizarTabelaEstoque(produtosCache);
    }

    function renderizarTabelaEstoque(lista) {
        const tbody = document.getElementById('tabelaEstoque');
        tbody.innerHTML = '';
        const hoje = new Date();

        lista.forEach(p => {
            let statusValidade = '';
            if(p.data_validade) {
                const val = new Date(p.data_validade);
                val.setDate(val.getDate() + 1); // Fuso
                const diff = Math.ceil((val - hoje) / (1000 * 60 * 60 * 24));
                if(diff < 0) statusValidade = '<span class="badge badge-out">VENCEU</span>';
                else if(diff < 10) statusValidade = `<span class="badge badge-low">${diff} dias</span>`;
                else statusValidade = `<span style="color:green">${val.toLocaleDateString()}</span>`;
            } else {
                statusValidade = '-';
            }

            const baixo = parseFloat(p.quantidade) <= parseFloat(p.estoque_minimo);
            const qtdHtml = baixo 
                ? `<span style="color:var(--danger); font-weight:bold">${p.quantidade}</span> ‚ö†Ô∏è` 
                : p.quantidade;

            tbody.innerHTML += `
                <tr>
                    <td>
                        <div style="font-weight:600">${p.nome}</div>
                        <div style="font-size:0.8rem; color:#888">${p.categoria || ''}</div>
                    </td>
                    <td>${qtdHtml} <small>${p.unidade}</small></td>
                    <td>${statusValidade}</td>
                    <td>R$ ${p.preco}</td>
                    <td style="text-align:right">
                         <button class="btn btn-outline" style="padding:4px 8px;" onclick="registrarBaixa(${p.id}, '${p.nome}')">‚ûñ</button>
                         <button class="btn btn-outline" style="padding:4px 8px;" onclick='editarItem(${JSON.stringify(p)})'>‚úèÔ∏è</button>
                         <button class="btn btn-outline" style="padding:4px 8px; color:red; border-color: #ffebee" onclick="deletarItem(${p.id})">üóëÔ∏è</button>
                    </td>
                </tr>
            `;
        });
    }

    // --- L√ìGICA DO HIST√ìRICO ---
    async function carregarHistorico() {
        const res = await fetch('/api/movimentacoes');
        const lista = await res.json();
        const tbody = document.getElementById('tabelaHistorico');
        tbody.innerHTML = lista.map(m => `
            <tr>
                <td>${new Date(m.data_movimentacao).toLocaleString()}</td>
                <td><strong>${m.produto_nome}</strong></td>
                <td>${formatarTipo(m.tipo)}</td>
                <td style="font-weight:bold">${m.quantidade} <small>${m.unidade || ''}</small></td>
            </tr>
        `).join('');
    }

    function formatarTipo(tipo) {
        if(tipo.includes('ENTRADA')) return `<span class="badge badge-in">ENTRADA</span>`;
        if(tipo.includes('SAIDA')) return `<span class="badge badge-out">SAIDA</span>`;
        return `<span class="badge badge-low">${tipo}</span>`;
    }

    // --- A√á√ïES DO USU√ÅRIO ---
    
    async function registrarBaixa(id, nome) {
        const qtd = prompt(`Baixa r√°pida: Quantos ${nome} sa√≠ram?`);
        if(!qtd) return;
        
        const res = await fetch(`${API_URL}/${id}/baixa`, {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ quantidade_saida: parseFloat(qtd.replace(',','.')) })
        });

        if(res.ok) {
            carregarEstoque(); // Atualiza estoque
            // Se estivermos no dashboard, atualiza ele tamb√©m
            atualizarDashboard();
        } else {
            alert('Erro ou estoque insuficiente.');
        }
    }

    function filtrarEstoque() {
        const termo = document.getElementById('buscaEstoque').value.toLowerCase();
        const filtrados = produtosCache.filter(p => p.nome.toLowerCase().includes(termo));
        renderizarTabelaEstoque(filtrados);
    }

    // --- MODAIS E CRUD ---
    function abrirModalCadastro() {
        editando = false;
        document.getElementById('formProduto').reset();
        document.getElementById('modalTitle').innerText = "Novo Item";
        document.getElementById('modalForm').style.display = 'flex';
    }

    function editarItem(p) {
        editando = true;
        document.getElementById('modalTitle').innerText = "Editar Item";
        document.getElementById('id_produto').value = p.id;
        document.getElementById('nome').value = p.nome;
        document.getElementById('categoria').value = p.categoria;
        document.getElementById('quantidade').value = p.quantidade;
        document.getElementById('unidade').value = p.unidade;
        document.getElementById('estoque_minimo').value = p.estoque_minimo;
        document.getElementById('preco').value = p.preco;
        if(p.data_validade) document.getElementById('data_validade').value = p.data_validade.split('T')[0];
        
        document.getElementById('modalForm').style.display = 'flex';
    }

    function fecharModais() {
        document.querySelectorAll('.modal-overlay').forEach(el => el.style.display = 'none');
    }

    document.getElementById('formProduto').addEventListener('submit', async (e) => {
        e.preventDefault();
        const dados = {
            nome: document.getElementById('nome').value,
            categoria: document.getElementById('categoria').value,
            quantidade: parseFloat(document.getElementById('quantidade').value),
            unidade: document.getElementById('unidade').value,
            estoque_minimo: parseFloat(document.getElementById('estoque_minimo').value),
            preco: parseFloat(document.getElementById('preco').value),
            data_validade: document.getElementById('data_validade').value
        };

        const id = document.getElementById('id_produto').value;
        const method = editando ? 'PUT' : 'POST';
        const url = editando ? `${API_URL}/${id}` : API_URL;

        await fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(dados)
        });

        fecharModais();
        carregarEstoque();
        atualizarDashboard();
    });

    async function deletarItem(id) {
        if(confirm('Tem certeza?')) {
            await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
            carregarEstoque();
            atualizarDashboard();
        }
    }

    // --- LISTA DE COMPRAS (SIMPLIFICADA) ---
    function gerarListaCompras() {
        const compras = produtosCache.filter(p => parseFloat(p.quantidade) <= parseFloat(p.estoque_minimo));
        if(compras.length === 0) return alert('Estoque OK!');
        
        const texto = "*LISTA DE COMPRAS üõí*\n" + compras.map(p => `- [ ] ${p.nome} (Atual: ${p.quantidade})`).join('\n');
        document.getElementById('textoLista').value = texto;
        document.getElementById('modalLista').style.display = 'flex';
    }

    function copiarLista() {
        document.getElementById('textoLista').select();
        document.execCommand('copy');
        alert('Copiado!');
    }
</script>

</body>
</html>