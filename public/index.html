<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Barista Pro | Gestão</title>
    
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>

    <!-- LOGIN -->
    <section id="login-screen" class="login-container">
        <div class="login-box">
            <div class="login-header">
                <i data-lucide="coffee" size="48" class="text-primary"></i>
                <h1>Barista Pro</h1>
                <p>Gestão na palma da mão</p>
            </div>
            <form id="loginForm" onsubmit="fazerLogin(event)">
                <div class="form-group"><label>Usuário</label><input type="text" id="loginUser" placeholder="Ex: admin" required></div>
                <div class="form-group"><label>Senha</label><input type="password" id="loginPass" placeholder="••••••" required></div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Entrar</button>
                <p id="loginError" class="error-msg"></p>
            </form>
        </div>
    </section>

    <!-- APP -->
    <div id="app-container" style="display: none;">
        
        <!-- MOBILE HEADER (Só aparece no celular) -->
        <div class="mobile-header">
            <button class="btn-icon-only" onclick="toggleSidebar()">
                <i data-lucide="menu" size="24" color="white"></i>
            </button>
            <div class="mobile-logo"><i data-lucide="coffee" size="20"></i> Barista Pro</div>
            <div style="width: 40px;"></div> <!-- Espaçador para centralizar logo -->
        </div>

        <!-- OVERLAY (Fundo escuro quando menu abre) -->
        <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

        <!-- SIDEBAR -->
        <nav class="sidebar" id="sidebar">
            <div class="logo"><i data-lucide="coffee"></i> Barista Pro</div>
            
            <div class="nav-label">Geral</div>
            <button class="menu-btn active" onclick="showScreen('dashboard')"><i data-lucide="layout-dashboard"></i> Dashboard</button>
            <button class="menu-btn" onclick="showScreen('estoque')"><i data-lucide="box"></i> Estoque</button>
            <button class="menu-btn" onclick="showScreen('cadastros')"><i data-lucide="package"></i> Cadastros</button>
            
            <div class="nav-label">Operação</div>
            <button class="menu-btn" onclick="showScreen('movimentacao')"><i data-lucide="arrow-left-right"></i> Movimentação</button>
            
            <div class="nav-label">Análise</div>
            <button class="menu-btn" onclick="showScreen('relatorios')"><i data-lucide="bar-chart-2"></i> Relatórios</button>
            <button class="menu-btn" onclick="showScreen('historico')"><i data-lucide="history"></i> Histórico</button>

            <div style="flex: 1;"></div>
            <div class="user-info">
                <div class="avatar"><i data-lucide="user"></i></div>
                <div><strong id="displayUser">Usuário</strong><small onclick="fazerLogout()" style="cursor:pointer; color:var(--primary)">Sair</small></div>
            </div>
        </nav>

        <!-- MAIN -->
        <main class="main-content">
            
            <!-- DASHBOARD -->
            <section id="dashboard" class="screen active">
                <header><div><h1>Dashboard</h1><div class="subtitle">Resumo do dia.</div></div><div id="dataAtual" style="color:var(--text-muted); font-size:0.9rem"></div></header>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-label">Valor em Estoque</div><div class="stat-value" id="dashValorTotal">R$ 0,00</div></div>
                    <div class="stat-card"><div class="stat-label">Itens Críticos</div><div class="stat-value" id="dashItensCriticos">0</div></div>
                    <div class="stat-card"><div class="stat-label">Vencendo (7 dias)</div><div class="stat-value" id="dashVencendo">0</div></div>
                </div>
                <h3 style="margin-bottom: 16px;">Atividades Recentes</h3>
                <div class="table-container">
                    <table><thead><tr><th>Data</th><th>Usuário</th><th>Produto</th><th>Tipo</th><th>Qtd</th></tr></thead><tbody id="dashUltimasAtividades"></tbody></table>
                </div>
            </section>

            <!-- ESTOQUE -->
            <section id="estoque" class="screen">
                <header><div><h1>Estoque</h1><div class="subtitle">Visão geral dos itens.</div></div></header>
                <div class="table-container">
                    <div class="toolbar">
                        <div class="search-wrapper"><i data-lucide="search"></i><input type="text" id="buscaEstoque" class="search-input" placeholder="Buscar item..." onkeyup="filtrarTabelaEstoque(this.value)"></div>
                        <button class="btn btn-secondary" onclick="gerarListaApenasCriticos()"><i data-lucide="alert-triangle" size="16"></i> Faltas</button>
                    </div>
                    <table><thead><tr><th>Produto</th><th>Categoria</th><th>Saldo</th><th>Validade</th><th>Status</th></tr></thead><tbody id="tabelaEstoque"></tbody></table>
                </div>
            </section>

            <!-- CADASTROS -->
            <section id="cadastros" class="screen">
                <header><div><h1>Cadastros</h1><div class="subtitle">Gerencie produtos e categorias.</div></div><button class="btn btn-primary" onclick="abrirModalCadastro()"><i data-lucide="plus"></i> <span class="hide-mobile">Novo</span> Item</button></header>
                <div class="grid-cadastros">
                    <!-- Esquerda: Categorias -->
                    <div class="stat-card cat-card-mobile" style="height: fit-content;">
                        <h3 style="margin-bottom: 15px;">Categorias</h3>
                        <div style="display: flex; gap: 8px; margin-bottom: 15px;">
                            <input id="novaCategoria" placeholder="Nova Categoria..." style="flex:1">
                            <button class="btn btn-secondary" onclick="adicionarCategoria()"><i data-lucide="plus"></i></button>
                        </div>
                        <ul id="listaCategorias" class="cat-list"></ul>
                    </div>
                    <!-- Direita: Lista de Produtos -->
                    <div class="table-container">
                        <div class="toolbar">
                            <div class="search-wrapper" style="width: 100%;"><i data-lucide="search"></i><input type="text" class="search-input" placeholder="Buscar produto..." onkeyup="filtrarTabelaCadastros(this.value)"></div>
                        </div>
                        <table><thead><tr><th>Produto</th><th>Categoria</th><th style="text-align:right">Ações</th></tr></thead><tbody id="tabelaCadastros"></tbody></table>
                    </div>
                </div>
            </section>

            <!-- MOVIMENTAÇÃO -->
            <section id="movimentacao" class="screen">
                <header><div><h1>Movimentação</h1><div class="subtitle">Entrada e Saída.</div></div></header>
                <div class="mode-toggle">
                    <button class="mode-btn active-saida" id="btnModoSaida" onclick="setModo('SAIDA')">SAÍDA</button>
                    <button class="mode-btn" id="btnModoEntrada" onclick="setModo('ENTRADA')">ENTRADA</button>
                </div>
                <div id="containerDataValidadeEntrada" style="margin-bottom: 20px; display: none;"></div> <!-- Mantido vazio pois é injetado no carrinho agora, mas o JS pode limpar -->
                
                <div class="pos-layout">
                    <div class="pos-col-left">
                        <div class="search-wrapper"><i data-lucide="search"></i><input type="text" id="buscaMovimento" class="search-input" placeholder="Buscar item..." onkeyup="renderizarTelaMovimento(this.value)"></div>
                        <div id="listaProdutosMovimento" class="pos-products"></div>
                    </div>
                    <div class="pos-cart">
                        <div class="cart-header"><h3 id="tituloCarrinho">Carrinho</h3></div>
                        <div class="cart-items" id="carrinhoLista"></div>
                        <div class="cart-footer"><button class="btn btn-primary" id="btnFinalizarMovimento" style="width: 100%;" onclick="finalizarMovimentacao()">Confirmar</button></div>
                    </div>
                </div>
            </section>

            <!-- RELATÓRIOS -->
            <section id="relatorios" class="screen">
                <header><h1>Relatórios</h1></header>
                <div class="stats-grid-reports">
                    <div class="stat-card report-card">
                        <div class="report-header"><h3 class="text-danger"><i data-lucide="calendar-off" size="18"></i> Validade</h3></div>
                        <div class="table-responsive"><table style="margin-top:10px; font-size:0.9rem"><thead><tr><th>Item</th><th>Vencimento</th><th>Status</th></tr></thead><tbody id="relVencimentos"></tbody></table></div>
                    </div>
                    <div class="stat-card report-card">
                        <div class="report-header"><h3 class="text-warning"><i data-lucide="alert-triangle" size="18"></i> Críticos</h3><button class="btn btn-ghost btn-sm" onclick="gerarListaApenasCriticos()"><i data-lucide="shopping-cart" size="16"></i></button></div>
                        <div class="table-responsive"><table style="margin-top:10px; font-size:0.9rem"><thead><tr><th>Item</th><th>Atual</th><th>Mín</th></tr></thead><tbody id="relCriticos"></tbody></table></div>
                    </div>
                    <div class="stat-card report-card">
                        <div class="report-header"><h3 class="text-primary"><i data-lucide="trending-up" size="18"></i> Top Saídas</h3></div>
                        <div class="table-responsive"><table style="margin-top:10px; font-size:0.9rem"><thead><tr><th>Item</th><th>Total</th></tr></thead><tbody id="relSaidos"></tbody></table></div>
                    </div>
                </div>
            </section>

            <!-- HISTÓRICO -->
            <section id="historico" class="screen">
                <header><h1>Histórico</h1></header>
                <div class="table-container">
                    <table><thead><tr><th>Data</th><th>Usuário</th><th>Produto</th><th>Tipo</th><th>Qtd</th></tr></thead><tbody id="tabelaHistoricoCompleta"></tbody></table>
                </div>
            </section>
        </main>
    </div>
    
    <div id="toast-container"></div>

    <!-- MODAL FORM -->
    <div id="modalForm" class="modal-overlay">
        <div class="modal-content">
            <h2 id="modalTitle" style="margin-bottom: 24px;">Novo Item</h2>
            <form id="formProduto">
                <input type="hidden" id="id_produto">
                <div class="form-row"><div class="form-group"><label>Nome</label><input id="nome" required></div><div class="form-group"><label>Categoria</label><select id="categoria"></select></div></div>
                <div class="form-row">
                    <div class="form-group"><label>Qtd Atual</label><input type="number" id="quantidade" step="0.01" required></div>
                    <div class="form-group"><label>Unidade</label><select id="unidade"><option value="un">un</option><option value="kg">kg</option><option value="g">g</option><option value="L">L</option><option value="ml">ml</option><option value="pct">pct</option></select></div>
                </div>
                <div class="form-row"><div class="form-group"><label>Mínimo</label><input type="number" id="estoque_minimo" step="0.01" required></div><div class="form-group"><label>Custo (R$)</label><input type="number" id="preco" step="0.01"></div></div>
                <div class="form-group"><label>Validade (Opcional)</label><input type="date" id="data_validade"></div>
                <p id="avisoEdicao" style="font-size: 0.8rem; color: #78716C; margin-bottom: 15px; display: none;">* Para alterar o estoque, use a tela "Movimentação".</p>
                <div style="display: flex; gap: 12px; margin-top: 24px;"><button type="button" class="btn btn-secondary" style="flex:1" onclick="fecharModais()">Cancelar</button><button type="submit" class="btn btn-primary" style="flex:1">Salvar</button></div>
            </form>
        </div>
    </div>

    <!-- MODAL LOTE -->
    <div id="modalLote" class="modal-overlay">
        <div class="modal-content">
            <h2 id="tituloModalLote" style="margin-bottom: 20px;">Lote</h2>
            <input type="hidden" id="idProdutoSelecionado">
            <div id="conteudoLoteEntrada" style="display:none;">
                <div class="form-group"><label>Nº Lote</label><input type="text" id="inputNumeroLote"></div>
                <div class="form-group"><label>Validade</label><input type="date" id="inputValidadeLote"></div>
            </div>
            <div id="conteudoLoteSaida" style="display:none;">
                <label style="margin-bottom:10px; display:block; font-weight:600;">Escolha o lote:</label>
                <div id="listaLotesDisponiveis" class="checklist-container" style="max-height: 150px;"></div>
            </div>
            <div class="form-group" style="margin-top: 20px;"><label>Quantidade</label><input type="number" id="inputQtdLote" step="0.01" style="font-size: 1.2rem; font-weight: bold;"></div>
            <div style="display: flex; gap: 12px; margin-top: 24px;"><button class="btn btn-secondary" style="flex:1" onclick="fecharModais()">Cancelar</button><button class="btn btn-primary" style="flex:1" onclick="confirmarAdicaoCarrinho()">Confirmar</button></div>
        </div>
    </div>

    <!-- MODAL LISTA -->
    <div id="modalResultado" class="modal-overlay">
        <div class="modal-content">
            <h2>Lista de Compras</h2>
            <textarea id="textoLista" style="width: 100%; height: 150px; margin: 15px 0; padding: 10px; border: 1px solid var(--border); border-radius: var(--radius-sm); font-family: monospace;"></textarea>
            <div style="display: flex; gap: 10px;"><button class="btn btn-secondary" style="flex:1" onclick="fecharModais()">Fechar</button><button class="btn btn-primary" style="flex:1" onclick="copiarLista()">Copiar</button></div>
        </div>
    </div>

    <script src="app.js"></script>
</body>
</html>